# مستندات API مربوط به ارائه‌دهندگان خدمات Connect-Yar

## مقدمه
این مستندات نحوه استفاده از APIهای مربوط به ارائه‌دهندگان خدمات را توضیح می‌دهد. این APIها به ارائه‌دهندگان خدمات اجازه می‌دهند تا به داشبوردهای مربوطه خود دسترسی داشته باشند و عملیات مرتبط با خدمات خود را مدیریت کنند.

## احراز هویت
سیستم احراز هویت ارائه‌دهندگان خدمات از رمز یکبار مصرف (OTP) از طریق پیامک استفاده می‌کند. پس از احراز هویت، یک توکن JWT برای دسترسی به APIهای محافظت‌شده صادر می‌شود.

### جریان احراز هویت
1. درخواست کد تأیید به شماره موبایل
2. دریافت و وارد کردن کد تأیید
3. تأیید کد و دریافت توکن دسترسی
4. ارسال توکن در درخواست‌های بعدی

## نقاط پایانی API

### 1. درخواست کد تأیید (OTP)

درخواست کد تأیید به شماره موبایل ارائه دهنده خدمات.

```
POST /api/provider/request-otp
```

**پارامترهای درخواست:**
```json
{
  "phone_number": "09123456789"
}
```

**پاسخ موفق:**
```json
{
  "status": "success",
  "message": "کد تأیید به شماره موبایل شما ارسال شد. این کد تا 2 دقیقه معتبر است.",
  "user_exists": true
}
```

**کدهای وضعیت پاسخ:**
- `200 OK`: درخواست با موفقیت انجام شد.
- `400 Bad Request`: پارامترهای ارسالی نامعتبر هستند.
- `403 Forbidden`: حساب کاربری غیرفعال یا تأیید نشده است.
- `429 Too Many Requests`: تعداد درخواست‌های ارسال کد بیش از حد مجاز است (محدودیت: 3 بار در 5 دقیقه).

### 2. تأیید کد OTP

تأیید کد دریافتی و احراز هویت کاربر.

```
POST /api/provider/verify-otp
```

**پارامترهای درخواست:**
```json
{
  "phone_number": "09123456789",
  "code": "123456"
}
```

**پاسخ موفق:**
```json
{
  "status": "success",
  "data": {
    "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "provider": {
      "id": 55,
      "name": "شرکت سرویس‌یار",
      "phone": "09123456789",
      "avatar": null,
      "category": "commercial"
    }
  }
}
```

**کدهای وضعیت پاسخ:**
- `200 OK`: احراز هویت با موفقیت انجام شد.
- `401 Unauthorized`: کد تأیید نامعتبر یا منقضی شده است.
- `403 Forbidden`: کاربر هنوز ثبت‌نام نکرده یا حساب او غیرفعال/تأیید نشده است.

### 3. ثبت‌نام ارائه دهنده خدمات جدید

ثبت‌نام یک ارائه دهنده خدمات جدید در سیستم.

```
POST /api/provider/register
```

**پارامترهای درخواست:**
```json
{
  "phone_number": "09123456789",
  "code": "123456",
  "name": "شرکت سرویس‌یار",
  "email": "info@example.com",
  "category": "commercial",
  "description": "ارائه خدمات تعمیر و نگهداری",
  "address": "تهران، خیابان ولیعصر",
  "national_code": "1234567890",
  "business_license": "12345"
}
```

**پاسخ موفق:**
```json
{
  "status": "success",
  "message": "ثبت‌نام شما با موفقیت انجام شد. حساب شما در انتظار تأیید است.",
  "data": {
    "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "provider": {
      "id": 56,
      "name": "شرکت سرویس‌یار",
      "phone": "09123456789",
      "avatar": null,
      "category": "commercial",
      "status": "pending"
    }
  }
}
```

**کدهای وضعیت پاسخ:**
- `200 OK`: ثبت‌نام با موفقیت انجام شد.
- `401 Unauthorized`: کد تأیید نامعتبر یا منقضی شده است.
- `409 Conflict`: کاربر با این شماره موبایل قبلاً ثبت‌نام کرده است.
- `422 Unprocessable Entity`: اطلاعات ارسالی نامعتبر هستند.

### 4. دریافت اطلاعات پروفایل

دریافت اطلاعات پروفایل ارائه دهنده خدمات.

```
GET /api/provider/profile
```

**هدرهای درخواست:**
```
Authorization: Bearer {token}
```

**پاسخ موفق:**
```json
{
  "status": "success",
  "data": {
    "provider": {
      "id": 55,
      "name": "شرکت سرویس‌یار",
      "email": "info@example.com",
      "phone": "09123456789",
      "category": "commercial",
      "status": "approved",
      "address": "تهران، خیابان ولیعصر",
      "description": "ارائه خدمات تعمیر و نگهداری",
      "national_code": "1234567890",
      "business_license": "12345",
      "rating": 4.5,
      "website": "https://example.com",
      "created_at": "2023-01-01T12:00:00Z",
      "last_activity_at": "2023-06-15T14:30:00Z"
    }
  }
}
```

**کدهای وضعیت پاسخ:**
- `200 OK`: درخواست با موفقیت انجام شد.
- `401 Unauthorized`: توکن نامعتبر یا منقضی شده است.
- `404 Not Found`: اطلاعات ارائه دهنده خدمات یافت نشد.

### 5. دریافت اطلاعات داشبورد

دریافت اطلاعات داشبورد ارائه دهنده خدمات.

```
GET /api/provider/dashboard
```

**هدرهای درخواست:**
```
Authorization: Bearer {token}
```

**پاسخ موفق:**
```json
{
  "status": "success",
  "data": {
    "provider": {
      "id": 55,
      "name": "شرکت سرویس‌یار",
      "rating": 4.5,
      "status": "approved",
      "last_activity_at": "2023-06-15T14:30:00Z"
    },
    "orders_stats": {
      "total": 120,
      "pending": 15,
      "in_progress": 25,
      "completed": 75,
      "cancelled": 5,
      "completion_rate": 62.5
    },
    "financial_stats": {
      "total_revenue": 25000000,
      "current_month_revenue": 3200000,
      "current_week_revenue": 850000,
      "available_balance": 1200000,
      "total_withdrawals": 18000000,
      "average_order_value": 333333.33
    },
    "recent_activities": [
      {
        "id": 142,
        "type": "order",
        "title": "سفارش جدید: #142",
        "description": "سفارش جدید به مبلغ 450,000 تومان دریافت شده است.",
        "status": "pending",
        "created_at": "2023-06-15T14:30:00Z"
      }
    ],
    "sales_chart": {
      "labels": ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور"],
      "data": [2100000, 1800000, 2500000, 3200000, 2900000, 3500000]
    }
  }
}
```

**کدهای وضعیت پاسخ:**
- `200 OK`: درخواست با موفقیت انجام شد.
- `401 Unauthorized`: توکن نامعتبر یا منقضی شده است.
- `403 Forbidden`: حساب ارائه دهنده خدمات هنوز تأیید نشده است.
- `404 Not Found`: اطلاعات ارائه دهنده خدمات یافت نشد.

## نکات امنیتی

### محدودیت درخواست (Rate Limiting)
برای جلوگیری از حملات فورس بروت، محدودیت ارسال کد تأیید به ۳ بار در ۵ دقیقه اعمال شده است.

### توکن دسترسی
- توکن‌های صادر شده برای ارائه‌دهندگان خدمات حاوی قابلیت `provider` هستند.
- این توکن‌ها برای دسترسی به تمام مسیرهای محافظت‌شده الزامی هستند.
- توکن‌ها باید به صورت `Bearer Token` در هدر `Authorization` ارسال شوند.

### انقضای توکن
توکن‌ها پس از مدت زمان مشخصی منقضی می‌شوند (معمولاً 24 ساعت). پس از انقضا، کاربر باید مجدداً احراز هویت شود. 